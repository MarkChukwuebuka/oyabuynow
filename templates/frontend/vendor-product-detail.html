{% extends "./vendor-dashboard-base.html" %}
{% load static %}
{% load currency_filters %}
{% load rating_tags dict_extras %}

{% block dashboard_content %}
<div class="product-detail-tab">
  <div class="title d-flex align-items-center justify-content-between">
    <div>
      <h2>{{ product.name }}</h2>
      <span class="title-leaf">
        <svg class="icon-width bg-gray">
          <use xlink:href="https://themes.pixelstrap.com/fastkart/assets/svg/leaf.svg#leaf"></use>
        </svg>
      </span>
    </div>
    <div class="d-flex gap-3">
      <a href="{% url 'update-product' product.id %}" class="btn theme-bg-color">
        <i data-feather="edit"></i> Edit Product
      </a>

      <button class="btn btn-animation" data-bs-toggle="modal"
        data-bs-target="#delete-product" data-id="{{ product.id }}" data-name="{{ product.name }}">
        <i data-feather="trash-2"></i> Delete
      </button>
    </div>
  </div>

  <div class="dashboard-bg-box p-4 mt-3">
    <div class="row">
      <!-- Product Media Gallery -->
      <div class="col-lg-5">
        <h5 class="fw-bold mb-3">Product Images</h5>
        <div class="row g-2">
          {% if product.product_media.all %}
            {% for media in product.product_media.all %}
              <div class="col-6">
                <a href="{{ media.image.url }}" data-lightbox="product-gallery" data-title="{{ product.name }}">
                  <img src="{{ media.image.url }}" alt="{{ product.name }}" class="img-fluid rounded shadow-sm gallery-img">
                </a>
              </div>
            {% endfor %}
          {% else %}
            <div class="col-12">
              <img src="{% static 'images/placeholder.jpg' %}" class="img-fluid rounded" alt="No image available">
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Product Information -->
      <div class="col-lg-7">
        <h4 class="fw-bold mb-3">General Information</h4>
        <div class="info-section">
          <p><strong>Name:</strong> {{ product.name }}</p>
          <p><strong>Short Description:</strong> {{ product.short_description|default:"—" }}</p>
          <p><strong>Full Description: <br></strong> {{ product.description| safe |default:"—" }}</p>
          <p><strong>Category:</strong> {{ product.category.name|default:"—" }}</p>
          <p><strong>Subcategories:</strong>
            {% for sub in product.sub_categories.all %}
              <span class="badge bg-light text-dark border me-1">{{ sub.name }}</span>
            {% empty %} — {% endfor %}
          </p>
          <p><strong>Rating:</strong></p>
          {% show_rating rating=product.rating %}
        </div>

        <h4 class="fw-bold mt-4 mb-3">Pricing & Discounts</h4>
        <div class="info-section">
          {% if product.percentage_discount %}
            <p><strong>Price:</strong> <del>{{ product.price|naira }}</del></p>
            <p><strong>Discounted Price:</strong> <span class="text-success">{{ product.discounted_price|naira }}</span></p>
            <p><strong>Discount:</strong> {{ product.percentage_discount }}%</p>

          {% else %}
            <p><strong>Price:</strong> {{ product.price|naira }}</p>
          {% endif %}
          <p><strong>Added to Sales:</strong> {% if product.add_product_to_sales %}Yes{% else %}No{% endif %}</p>
          {% if product.add_product_to_sales %}
            <p><strong>Sale Start:</strong> {{ product.sale_start|date:"M d, Y"|default:"—" }}</p>
            <p><strong>Sale End:</strong> {{ product.sale_end|date:"M d, Y"|default:"—" }}</p>
          {% endif %}
        </div>


        <h4 class="fw-bold mt-4 mb-3">Inventory & Attributes</h4>
        <div class="info-section">
          <p><strong>Stock:</strong> {{ product.stock }}</p>
          <p><strong>Quantity Sold:</strong> {{ product.quantity_sold|default:"0" }}</p>
          <p><strong>Viewed:</strong> {{ product.views|default:"0" }} time{{ product.views|pluralize }}</p>
          <p><strong>Weight:</strong> {{ product.weight|default:"—" }} kg</p>
          <p><strong>Dimensions:</strong> {{ product.dimensions|default:"—" }}</p>
          <p><strong>Sizes:</strong> {{ product.sizes|default:"—" }}</p>
        </div>

        <h4 class="fw-bold mt-4 mb-3">Additional Information</h4>
        <div class="info-section">
          <p><strong>Brand:</strong> {{ product.brand.name|default:"—" }}</p>

          <p><strong>Colors:</strong>
            {% if product.colors.all %}
              {% for color in product.colors.all %}
                <span class="badge bg-secondary me-1">{{ color.name }}</span>
              {% endfor %}
            {% else %} — {% endif %}
          </p>

          <p><strong>Tags:</strong>
            {% if product.tags.all %}
              {% for tag in product.tags.all %}
                <span class="badge bg-light text-dark border me-1">{{ tag.name }}</span>
              {% endfor %}
            {% else %} — {% endif %}
          </p>
        </div>

        <h4 class="fw-bold mt-4 mb-3">Metadata</h4>
        <div class="info-section">

          <p><strong>Created At:</strong> {{ product.created_at|date:"M d, Y H:i" }}</p>
          <p><strong>Updated At:</strong> {{ product.updated_at|date:"M d, Y H:i"|default:"—" }}</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade theme-modal" id="delete-product" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <h3 id="delete-message">Are you sure you want to delete this product?</h3>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-animation btn-md fw-bold" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn theme-bg-color btn-md fw-bold text-light delete-btn">
          Delete
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const csrfToken = "{{ csrf_token }}";

  document.addEventListener("DOMContentLoaded", function () {
    feather.replace();

    let currentProductId = null;
    const deleteModal = document.getElementById("delete-product");
    const deleteMessage = document.getElementById("delete-message");
    const deleteBtn = deleteModal.querySelector(".delete-btn");

    // Capture the current product ID when modal opens
    document.querySelectorAll("[data-bs-target='#delete-product']").forEach(link => {
      link.addEventListener("click", function () {
        currentProductId = this.dataset.id;
        const name = this.dataset.name;
        deleteMessage.textContent = `Are you sure you want to delete "${name}"?`;
      });
    });

    // Handle delete request
    deleteBtn.addEventListener("click", async function () {
      if (!currentProductId) return;

      try {
        const response = await fetch(`/delete-product/${currentProductId}/`, {
          method: "DELETE",
          headers: {
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/json",
          },
        });

        const data = await response.json();

        if (response.ok) {
          showToast(data.message || "Product deleted successfully.", "success");
          setTimeout(() => {
            window.location.href = "{% url 'vendor-dashboard-products' %}";
          }, 1000);
        } else {
          showToast(data.detail || data.message || "Failed to delete product.", "error");
        }
      } catch (error) {
        console.error("Error:", error);
        showToast("Network error. Please try again.", "error");
      }
    });
  });
</script>

<style>
  .info-section p {
    margin-bottom: 6px;
  }
  .gallery-img {
    object-fit: cover;
    height: 180px;
    width: 100%;
  }
  .info-section {
    background: #f9f9f9;
    padding: 10px 15px;
    border-radius: 8px;
    box-shadow: inset 0 0 2px rgba(0,0,0,0.05);
  }
</style>
{% endblock %}
