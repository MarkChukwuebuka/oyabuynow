{% extends "./vendor-dashboard-base.html" %}
{% load static %}
{% load currency_filters %}
{% load rating_tags dict_extras %}

{% block dashboard_content %}
<div class="product-tab">
  <div class="title">
    <h2>All Products</h2>
    <span class="title-leaf">
      <svg class="icon-width bg-gray">
        <use xlink:href="https://themes.pixelstrap.com/fastkart/assets/svg/leaf.svg#leaf"></use>
      </svg>
    </span>
  </div>

  <div class="table-responsive dashboard-bg-box">
    {% if vendor_products %}
      <table class="table product-table">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Images</th>
                                                    <th scope="col">Product Name</th>
                                                    <th scope="col">Price</th>
                                                    <th scope="col">Stock</th>
                                                    <th scope="col">Sales</th>
                                                    <th scope="col">Edit / Delete</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for product in vendor_products %}

                                                <tr>
                                                    <td class="product-image">
                                                        {% with product.product_media.first as first_media %}
                                                            {% if first_media %}
                                                                <img src="{{first_media.image.url}}"
                                                                class="blur-up lazyload" alt="{{product.name}}" height="50px" width="50px">
                                                            {% endif %}
                                                        {% endwith %}
                                                    </td>
                                                    <td>
                                                        <a href="{% url 'vendor-product-detail' product.slug %}">
                                                            <h6>{{ product.name }}</h6>
                                                        </a>
                                                    </td>
                                                    <td>
                                                        <h6>
                                                        {% if product.percentage_discount %}
                                                        <span class="theme-color fw-bold">
                                                            {{ product.discounted_price | naira }}
                                                        </span>
                                                        <del>{{ product.price | naira }}</del>
                                                        {% else %}
                                                        <span class="theme-color fw-bold">
                                                            {{ product.price | naira }}
                                                        </span>
                                                        {% endif %}
                                                        </h6>
                                                    </td>
                                                    <td>
                                                        <h6>{{product.stock}}</h6>
                                                    </td>
                                                    <td>
                                                        <h6>{{ product.quantity_sold }}</h6>
                                                    </td>
                                                    <td class="edit-delete">
                                                        <a href="{% url 'update-product' product.id %}" class="edit-btn" title="Edit">
                                                            <i data-feather="edit" class="edit"></i>
                                                        </a>

                                                        <!-- Delete Button -->
                                                        <a href="javascript:void()" data-bs-toggle="modal"
                                                            data-bs-target="#delete-product" data-name="{{ product.name }}"
                                                           data-id="{{ product.id }}" title="Delete">
                                                            <i data-feather="trash-2" class="delete"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                                {% endfor %}


                                            </tbody>
                                        </table>


                                        <nav class="custom-pagination">
                                            <ul class="pagination justify-content-center">
                                                <!-- Previous -->
                                                {% if vendor_products.has_previous %}
                                                    <li class="page-item">
                                                        <a class="page-link" href="?page={{ vendor_products.previous_page_number }}">
                                                            <i class="fa-solid fa-angles-left"></i>
                                                        </a>
                                                    </li>
                                                {% else %}
                                                    <li class="page-item disabled">
                                                        <span class="page-link"><i class="fa-solid fa-angles-left"></i></span>
                                                    </li>
                                                {% endif %}

                                                <!-- Page Numbers -->
                                                {% for num in vendor_products.paginator.page_range %}
                                                    {% if vendor_products.number == num %}
                                                        <li class="page-item active">
                                                            <span class="page-link">{{ num }}</span>
                                                        </li>
                                                    {% else %}
                                                        <li class="page-item">
                                                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                                        </li>
                                                    {% endif %}
                                                {% endfor %}

                                                <!-- Next -->
                                                {% if vendor_products.has_next %}
                                                    <li class="page-item">
                                                        <a class="page-link" href="?page={{ vendor_products.next_page_number }}">
                                                            <i class="fa-solid fa-angles-right"></i>
                                                        </a>
                                                    </li>
                                                {% else %}
                                                    <li class="page-item disabled">
                                                        <span class="page-link"><i class="fa-solid fa-angles-right"></i></span>
                                                    </li>
                                                {% endif %}
                                            </ul>
                                        </nav>
    {% else %}
      <h2>You have no products yet ...</h2>
    {% endif %}
  </div>
</div>


<div class="modal fade theme-modal" id="delete-product" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="modal-body">
        <h3 id="delete-message">Are you sure you want to delete this product?</h3>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-animation btn-md fw-bold" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn theme-bg-color btn-md fw-bold text-light delete-btn">
          Delete
        </button>
      </div>
    </div>
  </div>
</div>




<script>
  const csrfToken = "{{ csrf_token }}";

  document.addEventListener("DOMContentLoaded", function () {
    feather.replace();

    let currentProductId = null;
    const deleteModal = document.getElementById("delete-product");
    const deleteMessage = document.getElementById("delete-message");
    const deleteBtn = deleteModal.querySelector(".delete-btn");

    // Open modal
    document.querySelectorAll("[data-bs-target='#delete-product']").forEach(link => {
      link.addEventListener("click", function () {
        currentProductId = this.dataset.id;
        const name = this.dataset.name;
        deleteMessage.textContent = `Are you sure you want to delete "${name}"?`;
      });
    });

    // Handle delete confirmation
    deleteBtn.addEventListener("click", async function () {
      if (!currentProductId) return;

      try {
        const response = await fetch(`/delete-product/${currentProductId}/`, {
          method: "DELETE",
          headers: {
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/json",
          },
        });

        if (response.ok) {
          const data = await response.json();

          // Remove the row
          const link = document.querySelector(`[data-id='${currentProductId}']`);
          if (link) {
            const row = link.closest("tr");
            if (row) row.remove();
          }

          showToast(data.message || "Product deleted successfully.", "success");

          const modal = bootstrap.Modal.getInstance(deleteModal);
          modal.hide();
        } else {
          const data = await response.json();
          showToast(data.detail || data.message || "Failed to delete product.", "error");
        }
      } catch (error) {
        showToast("Network error. Please try again.", "error");
        console.error("Network error:", error);
      }
    });
  });
</script>


{% endblock %}
